<html>
    <head>
        <script
            type="text/javascript"
            src="../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * Created by PhpStorm.
 * User: Vict&oacute;ria Oliveira Gomes e Bruno Claudino Matias
 * Date: 10/07/18
 * Time: 12:21
 */

namespace mine_apple\Http\Controllers;

use Illuminate\Http\Request;
use mine_apple\Cartao;
use mine_apple\Financa;

class AssinaturaController
{

    /**
     * @author Vict&oacute;ria Gomes e Bruno Claudino
     * @param Request $request
     * @return \Illuminate\Contracts\View\Factory|\Illuminate\View\View
     *
     *
     * O request para completar a assinatura retorna o id do a ser utilizado no pagamento (em teoria).
     * Procura-se no banco o cart&atilde;o que corresponde a esse id e as informa&ccedil;&otilde;es referentes a ele s&atilde;o mandadas
     * para o moduloTEF, que verificar&aacute; as informa&ccedil;&otilde;es acerca do cart&atilde;o e retornar&aacute; se a compra pode ser processada ou
     * n&atilde;o
     * Caso a compra tenha sido autorizada, o valor referente a assinatura &eacute; repassado para o produtor respons&aacute;vel pelos
     * produtos dela
     */
    public function realizarAssinatura(Request $request)
    {
        $cartao = Cartao::where('id', $request-&gt;idCartao);
        $infosCartao = $cartao-&gt;numero_cartao . &quot;;&quot; . $cartao-&gt;titular . &quot;;&quot; . $cartao-&gt;validade . &quot;;&quot; .
            $cartao-&gt;codigo . &quot;;&quot; . $request-&gt;valor_compra;
        $consulta = $this-&gt;verificarCartao($infosCartao);
        if($consulta.equalTo('Cartao nao existente')){
            return view('realizacao_de_assinatura')-&gt;with('Cartao nao existente');
        }
        else if($consulta.equalTo('Nome do titular esta incorreto')){
            return view('realizacao_de_assinatura')-&gt;with('Nome do titular est&aacute; incorreto');
        }
        else if($consulta.equalTo('Data de vencimento esta incorreta')){
            return view('realizacao_de_assinatura')-&gt;with('Data de vencimento est&aacute; incorreta');
        }
        else if($consulta.equalTo('Codigo de seguran&ccedil;a est&aacute; incorreto')) {
            return view('realizacao_de_assinatura')-&gt;with('Codigo de seguran&ccedil;a est&aacute; incorreto');
        }
        else {
            $this-&gt;transferenciaValores($request-&gt;produtos);
            return view('realizacao_de_assinatura')-&gt;with('sucesso');
        }

    }


    /**
     * @author Vict&oacute;ria Gomes e Bruno Claudino
     * @param $produtos
     * 
     *
     * Ap&oacute;s a realiza&ccedil;&atilde;o da assinatura, esse m&eacute;todo &eacute; chamado e ele recebe um array contendo os produtos da assinatura
     * que acabou de ser ativada. Pega-se o id do produtor contido em cada produto, com isso busca-se a finan&ccedil;a do produtor e
     * soma-se o valor do produtor ao saldo dispon&iacute;vel do produtor
     *
     * O que fazer com o frete?
     *
     */
    public function transferenciaValores($produtos)
    {
        foreach ($produtos as $produto){
            $financa = Financa::where('usuario_id', $produto-&gt;produtor_id);
            $financa-&gt;saldo_disponivel = ($produto-&gt;valor - (($produto-&gt;valor*100)/5)) + $financa-&gt;saldo_disponivel;
        }
    }

    /**
     * Verifica um cart&atilde;o
     * @author Vict&oacute;ria Gomes
     * @param $infos
     * @return string
     */
    public function verificarCartao($infos)
    {
        $host = env('HOST');
        $port = env('PORTA');
        $sock = socket_create(AF_INET, SOCK_STREAM, 0);
        socket_connect($sock, $host, $port);
        socket_write($sock, $infos, strlen($infos));
        $reply = socket_read($sock, 1024);
        $reply = trim($reply);
        return $reply;
    }
}
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>